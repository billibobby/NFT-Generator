<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Generator - Layer-based Collection Creator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Add new API management scripts -->
    <script src="api-storage.js"></script>
    <script src="api-error-handler.js"></script>
    <script src="api-rate-limiter.js"></script>
    <script src="api-logger.js"></script>
    <script src="api-providers.js"></script>
    <script src="api-manager.js"></script>
    <script src="api-config.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header Section -->
        <header class="app-header">
            <h1>NFT Collection Generator</h1>
            <p>Upload trait layers, configure rarity, and generate unique NFT collections</p>
        </header>

        <!-- AI & Style Configuration Section -->
        <section class="ai-config-section" id="aiConfigSection">
            <div class="ai-config-header">
                <h2>0. AI & Style Configuration <span class="section-badge optional">Advanced - Optional</span></h2>
                <button class="toggle-btn" id="aiConfigToggle" aria-expanded="true" aria-label="Toggle AI configuration">▼</button>
            </div>
            <div class="ai-config-content" id="aiConfigContent">
                
                <!-- API Provider Configuration -->
                <div class="config-subsection">
                    <h3>API Provider Configuration</h3>
                    <div class="security-warning" id="securityWarning">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-content">
                            <strong>Security Notice:</strong> API keys are stored locally in your browser. 
                            Do not use this tool on shared or public computers. 
                            <span id="httpsWarning" style="display: none;">
                                <br><strong>Warning:</strong> You are using HTTP. API keys should only be entered on HTTPS sites.
                            </span>
                        </div>
                    </div>
                    <div class="provider-cards-grid" id="apiProviderCards">
                        
                        <!-- Gemini Provider Card -->
                        <div class="provider-card provider-card-disabled" data-provider="gemini">
                            <div class="provider-header">
                                <div class="provider-logo gemini-logo"></div>
                                <span class="provider-name">Gemini <span class="coming-soon-badge">Coming Soon</span></span>
                            </div>
                            <div class="api-key-input-group">
                                <input type="password" id="geminiApiKey" class="api-key-input" placeholder="Not available yet" aria-label="Gemini API key" disabled>
                                <button id="geminiValidateBtn" class="validate-btn" disabled>Validate</button>
                            </div>
                            <div class="status-indicator" id="geminiStatus">Not available</div>
                            <div class="quota-display" id="geminiQuota" style="display: none;">
                                <span class="quota-text">Remaining: <span class="quota-remaining">-</span> / <span class="quota-limit">-</span></span>
                                <div class="quota-progress-bar">
                                    <div class="quota-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="cost-badge">$0.039 per image</div>
                            <button class="remove-key-btn" id="geminiRemoveBtn" style="display: none;">Remove Key</button>
                        </div>

                        <!-- OpenAI Provider Card -->
                        <div class="provider-card" data-provider="openai">
                            <div class="provider-header">
                                <div class="provider-logo openai-logo"></div>
                                <span class="provider-name">OpenAI</span>
                            </div>
                            <div class="api-key-input-group">
                                <input type="password" id="openaiApiKey" class="api-key-input" placeholder="Enter OpenAI API key" aria-label="OpenAI API key">
                                <button id="openaiValidateBtn" class="validate-btn">Validate</button>
                            </div>
                            <div class="status-indicator" id="openaiStatus">Not configured</div>
                            <div class="quota-display" id="openaiQuota" style="display: none;">
                                <span class="quota-text">Remaining: <span class="quota-remaining">-</span> / <span class="quota-limit">-</span></span>
                                <div class="quota-progress-bar">
                                    <div class="quota-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="cost-badge">$0.080 per image</div>
                            <button class="remove-key-btn" id="openaiRemoveBtn" style="display: none;">Remove Key</button>
                        </div>

                        <!-- Stable Diffusion Provider Card -->
                        <div class="provider-card" data-provider="stablediffusion">
                            <div class="provider-header">
                                <div class="provider-logo stablediffusion-logo"></div>
                                <span class="provider-name">Stable Diffusion</span>
                            </div>
                            <div class="api-key-input-group">
                                <input type="password" id="stableDiffusionApiKey" class="api-key-input" placeholder="Enter Stable Diffusion API key" aria-label="Stable Diffusion API key">
                                <button id="stableDiffusionValidateBtn" class="validate-btn">Validate</button>
                            </div>
                            <div class="status-indicator" id="stableDiffusionStatus">Not configured</div>
                            <div class="quota-display" id="stableDiffusionQuota" style="display: none;">
                                <span class="quota-text">Remaining: <span class="quota-remaining">-</span> / <span class="quota-limit">-</span></span>
                                <div class="quota-progress-bar">
                                    <div class="quota-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="cost-badge">$0.050 per image</div>
                            <button class="remove-key-btn" id="stableDiffusionRemoveBtn" style="display: none;">Remove Key</button>
                        </div>

                        <!-- Procedural Provider Card -->
                        <div class="provider-card" data-provider="procedural">
                            <div class="provider-header">
                                <div class="provider-logo procedural-logo" data-provider="P"></div>
                                <span class="provider-name">Procedural (Free)</span>
                            </div>
                            <p class="help-text no-api-message">No API key required</p>
                            <div class="status-indicator valid" id="proceduralStatus">Ready</div>
                            <div class="cost-badge cost-badge-free">Free</div>
                        </div>
                    </div>
                </div>

                    <!-- Active Provider Selector -->
                    <div class="active-provider-section">
                        <h4>Active Provider</h4>
                        <div class="provider-radio-group" id="activeProviderSelector" role="radiogroup" aria-label="Select active provider">
                            <label class="provider-radio-label provider-radio-disabled">
                                <input type="radio" name="activeProvider" value="gemini" id="activeProviderGemini" disabled>
                                <span>Gemini (Coming Soon)</span>
                            </label>
                            <label class="provider-radio-label">
                                <input type="radio" name="activeProvider" value="openai" id="activeProviderOpenai">
                                <span>OpenAI</span>
                            </label>
                            <label class="provider-radio-label">
                                <input type="radio" name="activeProvider" value="stablediffusion" id="activeProviderStableDiffusion">
                                <span>Stable Diffusion</span>
                            </label>
                            <label class="provider-radio-label">
                                <input type="radio" name="activeProvider" value="procedural" id="activeProviderProcedural">
                                <span>Procedural</span>
                            </label>
                        </div>
                    </div>

                    <!-- Export/Import Configuration -->
                    <div class="config-actions">
                        <button id="exportConfigBtn" class="action-btn">Export Config</button>
                        <button id="importConfigBtn" class="action-btn">Import Config</button>
                    </div>
                </div>

                <!-- Master Style Configuration -->
                <div class="config-subsection">
                    <h3>Master Style Configuration</h3>
                    <div class="style-config-grid">
                        
                        <!-- Style Preset Selector -->
                        <div class="form-group">
                            <label for="stylePresetDropdown">Style Preset</label>
                            <select id="stylePresetDropdown" class="style-preset-selector" aria-label="Select style preset">
                                <option value="">Custom</option>
                                <option value="cyberpunk">Cyberpunk</option>
                                <option value="medieval">Medieval Fantasy</option>
                                <option value="minimalist">Minimalist</option>
                                <option value="retro">Retro 80s</option>
                                <option value="organic">Organic Nature</option>
                                <option value="abstract">Abstract Art</option>
                            </select>
                        </div>

                        <!-- Master Style Prompt -->
                        <div class="form-group">
                            <label for="masterStylePrompt">Master Style Prompt</label>
                            <textarea id="masterStylePrompt" class="master-prompt-textarea" placeholder="e.g., cyberpunk neon art with glowing edges" maxlength="500" aria-label="Master style prompt"></textarea>
                            <div class="char-counter"><span id="promptCharCount">0</span>/500</div>
                        </div>

                        <!-- Inheritance Level -->
                        <div class="form-group">
                            <label>Inheritance Level</label>
                            <div class="inheritance-level-group" id="inheritanceLevel" role="radiogroup" aria-label="Select inheritance level">
                                <label class="inheritance-radio-label">
                                    <input type="radio" name="inheritanceLevel" value="strict">
                                    <span>Strict</span>
                                </label>
                                <label class="inheritance-radio-label">
                                    <input type="radio" name="inheritanceLevel" value="moderate" checked>
                                    <span>Moderate</span>
                                </label>
                                <label class="inheritance-radio-label">
                                    <input type="radio" name="inheritanceLevel" value="loose">
                                    <span>Loose</span>
                                </label>
                            </div>
                        </div>

                        <!-- Global Negative Prompts -->
                        <div class="form-group">
                            <label for="globalNegativePrompts">Global Negative Prompts</label>
                            <textarea id="globalNegativePrompts" class="negative-prompts-textarea" placeholder="e.g., blurry, low quality, distorted" aria-label="Global negative prompts"></textarea>
                        </div>

                        <!-- Color Palette Lock -->
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="colorPaletteLock">
                                <span>Lock Color Palette</span>
                            </label>
                            <div class="color-palette-grid" id="colorPaletteGrid">
                                <input type="color" class="color-picker-item" data-index="0" value="#6366f1" aria-label="Color 1">
                                <input type="color" class="color-picker-item" data-index="1" value="#8b5cf6" aria-label="Color 2">
                                <input type="color" class="color-picker-item" data-index="2" value="#06b6d4" aria-label="Color 3">
                                <input type="color" class="color-picker-item" data-index="3" value="#10b981" aria-label="Color 4">
                                <input type="color" class="color-picker-item" data-index="4" value="#f59e0b" aria-label="Color 5">
                            </div>
                        </div>

                        <!-- Preview Button -->
                        <div class="form-group">
                            <button id="previewStyleBtn" class="action-btn">Preview Style Prompt</button>
                        </div>
                    </div>
                </div>

                <!-- Generation Mode Configuration -->
                <div class="config-subsection">
                    <h3>Generation Mode Configuration</h3>
                    
                    <!-- Global AI Toggle -->
                    <div class="global-ai-toggle">
                        <label class="checkbox-label">
                            <input type="checkbox" id="globalAiToggle">
                            <span>Use AI Generation</span>
                        </label>
                        <p class="help-text">Enable AI-powered trait generation. When disabled, all categories use procedural generation.</p>
                    </div>

                    <!-- Per-Category Mode Selectors -->
                    <div class="generation-mode-grid">
                        <div class="generation-mode-row">
                            <span class="category-label">Background</span>
                            <div class="mode-radio-group" id="bgGenerationMode" role="radiogroup" aria-label="Background generation mode">
                                <label class="mode-radio-label">
                                    <input type="radio" name="bgMode" value="procedural" checked>
                                    <span>Procedural</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="bgMode" value="ai">
                                    <span>AI</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="bgMode" value="hybrid">
                                    <span>Hybrid</span>
                                </label>
                            </div>
                        </div>

                        <div class="generation-mode-row">
                            <span class="category-label">Body</span>
                            <div class="mode-radio-group" id="bodyGenerationMode" role="radiogroup" aria-label="Body generation mode">
                                <label class="mode-radio-label">
                                    <input type="radio" name="bodyMode" value="procedural" checked>
                                    <span>Procedural</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="bodyMode" value="ai">
                                    <span>AI</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="bodyMode" value="hybrid">
                                    <span>Hybrid</span>
                                </label>
                            </div>
                        </div>

                        <div class="generation-mode-row">
                            <span class="category-label">Eyes</span>
                            <div class="mode-radio-group" id="eyesGenerationMode" role="radiogroup" aria-label="Eyes generation mode">
                                <label class="mode-radio-label">
                                    <input type="radio" name="eyesMode" value="procedural" checked>
                                    <span>Procedural</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="eyesMode" value="ai">
                                    <span>AI</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="eyesMode" value="hybrid">
                                    <span>Hybrid</span>
                                </label>
                            </div>
                        </div>

                        <div class="generation-mode-row">
                            <span class="category-label">Mouth</span>
                            <div class="mode-radio-group" id="mouthGenerationMode" role="radiogroup" aria-label="Mouth generation mode">
                                <label class="mode-radio-label">
                                    <input type="radio" name="mouthMode" value="procedural" checked>
                                    <span>Procedural</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="mouthMode" value="ai">
                                    <span>AI</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="mouthMode" value="hybrid">
                                    <span>Hybrid</span>
                                </label>
                            </div>
                        </div>

                        <div class="generation-mode-row">
                            <span class="category-label">Hat</span>
                            <div class="mode-radio-group" id="hatGenerationMode" role="radiogroup" aria-label="Hat generation mode">
                                <label class="mode-radio-label">
                                    <input type="radio" name="hatMode" value="procedural" checked>
                                    <span>Procedural</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="hatMode" value="ai">
                                    <span>AI</span>
                                </label>
                                <label class="mode-radio-label">
                                    <input type="radio" name="hatMode" value="hybrid">
                                    <span>Hybrid</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Hybrid Opacity Slider -->
                    <div class="hybrid-opacity-section">
                        <label for="hybridOpacity">Hybrid Overlay Opacity: <span id="hybridOpacityValue">40</span>%</label>
                        <input type="range" id="hybridOpacity" min="0" max="100" value="40" class="slider" aria-label="Hybrid overlay opacity">
                    </div>
                </div>

                <!-- Cost Estimation -->
                <div class="config-subsection">
                    <h3>Cost Estimation</h3>
                    <div class="cost-estimator" id="costEstimator">
                        
                        <!-- Collection Size Input -->
                        <div class="cost-input-group">
                            <label for="costCollectionSize">Collection Size</label>
                            <input type="number" id="costCollectionSize" min="1" max="10000" value="100" aria-label="Collection size for cost estimation">
                        </div>

                        <!-- Cost Breakdown Table -->
                        <table class="cost-breakdown-table">
                            <thead>
                                <tr>
                                    <th>Provider</th>
                                    <th>Cost/Image</th>
                                    <th>AI Categories</th>
                                    <th>Collection Size</th>
                                    <th>Total Cost</th>
                                </tr>
                            </thead>
                            <tbody id="costBreakdownBody">
                                <tr class="cost-row cost-row-disabled" data-provider="gemini">
                                    <td>Gemini <span class="coming-soon-badge">Coming Soon</span></td>
                                    <td>N/A</td>
                                    <td class="ai-categories-count">0</td>
                                    <td class="collection-size-display">100</td>
                                    <td class="provider-cost">N/A</td>
                                </tr>
                                <tr class="cost-row" data-provider="openai">
                                    <td>OpenAI</td>
                                    <td>$0.080</td>
                                    <td class="ai-categories-count">0</td>
                                    <td class="collection-size-display">100</td>
                                    <td class="provider-cost">$0.00</td>
                                </tr>
                                <tr class="cost-row" data-provider="stablediffusion">
                                    <td>Stable Diffusion</td>
                                    <td>$0.050</td>
                                    <td class="ai-categories-count">0</td>
                                    <td class="collection-size-display">100</td>
                                    <td class="provider-cost">$0.00</td>
                                </tr>
                                <tr class="cost-row" data-provider="procedural">
                                    <td>Procedural (Free)</td>
                                    <td><span class="cost-badge-free">Free</span></td>
                                    <td class="ai-categories-count">0</td>
                                    <td class="collection-size-display">100</td>
                                    <td class="provider-cost">$0.00</td>
                                </tr>
                                <tr class="cost-total">
                                    <td colspan="4"><strong>Estimated Total (Active Provider)</strong></td>
                                    <td><strong id="estimatedCost">$0.00</strong></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Cost Warning -->
                        <div class="cost-warning" id="costWarning" style="display: none;">
                            ⚠️ Estimated cost exceeds $10. Consider reducing collection size or disabling AI for some categories.
                        </div>
                    </div>
                </div>

                <!-- Budget Management -->
                <div class="config-subsection">
                    <h3>Budget Management <span class="section-badge optional">Optional</span></h3>
                    <div class="budget-controls">
                        
                        <!-- Per-provider budget inputs -->
                        <div class="budget-provider-grid">
                            <div class="budget-provider-row" data-provider="gemini">
                                <div class="provider-info">
                                    <span class="provider-name">Gemini</span>
                                    <span class="provider-cost">$0.039/image</span>
                                </div>
                                <div class="budget-inputs">
                                    <div class="budget-input-group">
                                        <label for="geminiDailyBudget">Daily Limit</label>
                                        <input type="number" id="geminiDailyBudget" min="0" step="0.01" value="5.00" aria-label="Gemini daily budget limit">
                                    </div>
                                    <div class="budget-input-group">
                                        <label for="geminiMonthlyBudget">Monthly Limit</label>
                                        <input type="number" id="geminiMonthlyBudget" min="0" step="0.01" value="50.00" aria-label="Gemini monthly budget limit">
                                    </div>
                                </div>
                                <div class="budget-status">
                                    <div class="budget-remaining">
                                        <span class="budget-label">Daily Remaining:</span>
                                        <span class="budget-value" id="geminiDailyRemaining">$5.00</span>
                                    </div>
                                    <div class="budget-progress">
                                        <div class="budget-progress-bar">
                                            <div class="budget-progress-fill" id="geminiDailyProgress" style="width: 0%"></div>
                                        </div>
                                        <span class="budget-percentage" id="geminiDailyPercentage">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="budget-provider-row" data-provider="openai">
                                <div class="provider-info">
                                    <span class="provider-name">OpenAI</span>
                                    <span class="provider-cost">$0.080/image</span>
                                </div>
                                <div class="budget-inputs">
                                    <div class="budget-input-group">
                                        <label for="openaiDailyBudget">Daily Limit</label>
                                        <input type="number" id="openaiDailyBudget" min="0" step="0.01" value="10.00" aria-label="OpenAI daily budget limit">
                                    </div>
                                    <div class="budget-input-group">
                                        <label for="openaiMonthlyBudget">Monthly Limit</label>
                                        <input type="number" id="openaiMonthlyBudget" min="0" step="0.01" value="100.00" aria-label="OpenAI monthly budget limit">
                                    </div>
                                </div>
                                <div class="budget-status">
                                    <div class="budget-remaining">
                                        <span class="budget-label">Daily Remaining:</span>
                                        <span class="budget-value" id="openaiDailyRemaining">$10.00</span>
                                    </div>
                                    <div class="budget-progress">
                                        <div class="budget-progress-bar">
                                            <div class="budget-progress-fill" id="openaiDailyProgress" style="width: 0%"></div>
                                        </div>
                                        <span class="budget-percentage" id="openaiDailyPercentage">0%</span>
                                    </div>
                                </div>
                            </div>

                            <div class="budget-provider-row" data-provider="stablediffusion">
                                <div class="provider-info">
                                    <span class="provider-name">Stable Diffusion</span>
                                    <span class="provider-cost">$0.050/image</span>
                                </div>
                                <div class="budget-inputs">
                                    <div class="budget-input-group">
                                        <label for="stablediffusionDailyBudget">Daily Limit</label>
                                        <input type="number" id="stablediffusionDailyBudget" min="0" step="0.01" value="7.50" aria-label="Stable Diffusion daily budget limit">
                                    </div>
                                    <div class="budget-input-group">
                                        <label for="stablediffusionMonthlyBudget">Monthly Limit</label>
                                        <input type="number" id="stablediffusionMonthlyBudget" min="0" step="0.01" value="75.00" aria-label="Stable Diffusion monthly budget limit">
                                    </div>
                                </div>
                                <div class="budget-status">
                                    <div class="budget-remaining">
                                        <span class="budget-label">Daily Remaining:</span>
                                        <span class="budget-value" id="stablediffusionDailyRemaining">$7.50</span>
                                    </div>
                                    <div class="budget-progress">
                                        <div class="budget-progress-bar">
                                            <div class="budget-progress-fill" id="stablediffusionDailyProgress" style="width: 0%"></div>
                                        </div>
                                        <span class="budget-percentage" id="stablediffusionDailyPercentage">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Global budget cap -->
                        <div class="budget-global">
                            <div class="form-group">
                                <label for="globalMonthlyBudget">Global Monthly Budget</label>
                                <input type="number" id="globalMonthlyBudget" min="0" step="1" value="200.00" aria-label="Global monthly budget limit">
                            </div>
                            <div class="global-budget-status">
                                <span class="budget-label">Monthly Remaining:</span>
                                <span class="budget-value" id="globalMonthlyRemaining">$200.00</span>
                            </div>
                        </div>

                        <!-- Warning thresholds -->
                        <div class="budget-thresholds">
                            <div class="form-group">
                                <label for="budgetWarningThreshold">Warning Threshold</label>
                                <select id="budgetWarningThreshold" aria-label="Budget warning threshold">
                                    <option value="50">50%</option>
                                    <option value="75" selected>75%</option>
                                    <option value="90">90%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analytics Dashboard -->
                <div class="config-subsection">
                    <h3>Cost Analytics</h3>
                    <div class="analytics-dashboard">
                        
                        <!-- Summary cards -->
                        <div class="analytics-summary">
                            <div class="stat-card">
                                <span class="stat-label">Total Spend</span>
                                <span class="stat-value" id="totalSpend">$0.00</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Images Generated</span>
                                <span class="stat-value" id="totalImages">0</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Avg Cost/Image</span>
                                <span class="stat-value" id="avgCost">$0.00</span>
                            </div>
                            <div class="stat-card">
                                <span class="stat-label">Cache Savings</span>
                                <span class="stat-value" id="cacheSavings">$0.00</span>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="analytics-charts">
                            <div class="chart-container">
                                <h4>Spend Trend (Last 30 Days)</h4>
                                <canvas id="spendTrendChart" width="600" height="300" aria-label="Spend trend chart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Provider Breakdown</h4>
                                <canvas id="providerBreakdownChart" width="300" height="300" aria-label="Provider breakdown chart"></canvas>
                            </div>
                        </div>

                        <!-- Transaction table -->
                        <div class="analytics-table">
                            <h4>Recent Transactions</h4>
                            <div class="table-container">
                                <table id="transactionTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Provider</th>
                                            <th>Category</th>
                                            <th>Cost</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionTableBody">
                                        <tr>
                                            <td colspan="5" class="no-data">No transactions yet</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Export button -->
                        <div class="analytics-actions">
                            <button id="exportAnalyticsBtn" class="btn-secondary">Export Report</button>
                            <button id="clearAnalyticsBtn" class="btn-secondary">Clear Data</button>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Quality Assurance Configuration Section -->
        <section class="qa-config-section" id="qaConfigSection">
            <div class="qa-config-header">
                <h2>1.5. Quality Assurance</h2>
                <button class="toggle-btn" id="qaConfigToggle" aria-expanded="false">▼</button>
            </div>
            <div class="qa-config-content" id="qaConfigContent" style="display: none;">
                
                <!-- Preview Mode Toggle -->
                <div class="config-subsection">
                    <h3>Preview Mode</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="qaPreviewMode">
                        <span>Enable Preview Generation (3-5 samples per category)</span>
                    </label>
                    <div class="form-group">
                        <label for="qaSamplesPerCategory">Samples per Category: <span id="qaSamplesValue">5</span></label>
                        <input type="range" id="qaSamplesPerCategory" min="3" max="10" value="5" class="slider">
                    </div>
                </div>

                <!-- Consistency Thresholds -->
                <div class="config-subsection">
                    <h3>Consistency Thresholds</h3>
                    <div class="threshold-grid">
                        <div class="form-group">
                            <label for="qaConsistencyThreshold">Minimum Consistency Score: <span id="qaConsistencyValue">60</span></label>
                            <input type="range" id="qaConsistencyThreshold" min="0" max="100" value="60" class="slider">
                        </div>
                        <div class="form-group">
                            <label for="qaOutlierThreshold">Outlier Detection Threshold: <span id="qaOutlierValue">60</span></label>
                            <input type="range" id="qaOutlierThreshold" min="0" max="100" value="60" class="slider">
                        </div>
                    </div>
                </div>

                <!-- Real-time Analysis Toggle -->
                <div class="config-subsection">
                    <label class="checkbox-label">
                        <input type="checkbox" id="qaRealTimeAnalysis" checked>
                        <span>Enable Real-time Analysis (analyze images as they generate)</span>
                    </label>
                </div>

                <!-- Regeneration Queue Status -->
                <div class="config-subsection">
                    <h3>Regeneration Queue</h3>
                    <div class="queue-status">
                        <div class="stat-card">
                            <span class="stat-label">Pending</span>
                            <span class="stat-value" id="qaPendingCount">0</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Processing</span>
                            <span class="stat-value" id="qaProcessingCount">0</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Completed</span>
                            <span class="stat-value" id="qaCompletedCount">0</span>
                        </div>
                    </div>
                    <button id="qaProcessQueueBtn" class="btn-secondary">Process Queue</button>
                    <button id="qaClearQueueBtn" class="btn-secondary">Clear Queue</button>
                </div>

                <!-- Export Quality Report -->
                <div class="config-subsection">
                    <h3>Quality Reports</h3>
                    <button id="qaExportReportBtn" class="btn-secondary">Export Quality Report</button>
                </div>

            </div>
        </section>

        <!-- Trait Layer Upload Area -->
        <section class="trait-upload-section" id="traitUpload">
            <h2>1. Generate Trait Layers</h2>
            <div class="trait-categories">
                <!-- Background Category -->
                <div class="trait-category">
                    <h3>Background</h3>
                    <label for="bg-numTraits">Number of Traits: <span class="slider-value" id="bg-numTraits-value">20</span></label>
                    <input type="range" id="bg-numTraits" min="13" max="50" value="20" class="slider">
                    <label for="bg-complexity">Complexity: <span class="slider-value" id="bg-complexity-value">5</span></label>
                    <input type="range" id="bg-complexity" min="1" max="10" value="5" class="slider">
                    <label for="bg-colorSeed">Color Seed:</label>
                    <input type="text" id="bg-colorSeed" placeholder="e.g., #FF5733 or random" class="color-seed-input">
                    <div class="trait-preview-container"></div>
                </div>

                <!-- Body Category -->
                <div class="trait-category">
                    <h3>Body</h3>
                    <label for="body-numTraits">Number of Traits: <span class="slider-value" id="body-numTraits-value">20</span></label>
                    <input type="range" id="body-numTraits" min="13" max="50" value="20" class="slider">
                    <label for="body-complexity">Complexity: <span class="slider-value" id="body-complexity-value">5</span></label>
                    <input type="range" id="body-complexity" min="1" max="10" value="5" class="slider">
                    <label for="body-colorSeed">Color Seed:</label>
                    <input type="text" id="body-colorSeed" placeholder="e.g., #FF5733 or random" class="color-seed-input">
                    <div class="trait-preview-container"></div>
                </div>

                <!-- Eyes Category -->
                <div class="trait-category">
                    <h3>Eyes</h3>
                    <label for="eyes-numTraits">Number of Traits: <span class="slider-value" id="eyes-numTraits-value">20</span></label>
                    <input type="range" id="eyes-numTraits" min="13" max="50" value="20" class="slider">
                    <label for="eyes-complexity">Complexity: <span class="slider-value" id="eyes-complexity-value">5</span></label>
                    <input type="range" id="eyes-complexity" min="1" max="10" value="5" class="slider">
                    <label for="eyes-colorSeed">Color Seed:</label>
                    <input type="text" id="eyes-colorSeed" placeholder="e.g., #FF5733 or random" class="color-seed-input">
                    <div class="trait-preview-container"></div>
                </div>

                <!-- Mouth Category -->
                <div class="trait-category">
                    <h3>Mouth</h3>
                    <label for="mouth-numTraits">Number of Traits: <span class="slider-value" id="mouth-numTraits-value">20</span></label>
                    <input type="range" id="mouth-numTraits" min="13" max="50" value="20" class="slider">
                    <label for="mouth-complexity">Complexity: <span class="slider-value" id="mouth-complexity-value">5</span></label>
                    <input type="range" id="mouth-complexity" min="1" max="10" value="5" class="slider">
                    <label for="mouth-colorSeed">Color Seed:</label>
                    <input type="text" id="mouth-colorSeed" placeholder="e.g., #FF5733 or random" class="color-seed-input">
                    <div class="trait-preview-container"></div>
                </div>

                <!-- Hat Category -->
                <div class="trait-category">
                    <h3>Hat</h3>
                    <label for="hat-numTraits">Number of Traits: <span class="slider-value" id="hat-numTraits-value">20</span></label>
                    <input type="range" id="hat-numTraits" min="13" max="50" value="20" class="slider">
                    <label for="hat-complexity">Complexity: <span class="slider-value" id="hat-complexity-value">5</span></label>
                    <input type="range" id="hat-complexity" min="1" max="10" value="5" class="slider">
                    <label for="hat-colorSeed">Color Seed:</label>
                    <input type="text" id="hat-colorSeed" placeholder="e.g., #FF5733 or random" class="color-seed-input">
                    <div class="trait-preview-container"></div>
                </div>
            </div>
            <div class="generate-traits-btn-container">
                <button type="button" class="btn-primary" id="generateTraitsBtn">Generate Traits</button>
            </div>
        </section>

        <!-- Rarity Configuration Area -->
        <section class="rarity-config-section" id="rarityConfig">
            <h2>2. Configure Rarity</h2>
            <p class="rarity-status" id="rarityStatus">Generate traits first to configure rarity</p>
            <div class="rarity-controls-container"></div>
            <div class="rarity-validation-summary" id="rarityValidationSummary"></div>
            <button type="button" class="btn-secondary" id="resetRarityBtn" style="display:none;">Reset All to Equal Weights</button>
        </section>

        <!-- Generation Controls -->
        <section class="generation-section" id="generationControls">
            <h2>3. Generate Collection</h2>
            <form class="generation-form">
                <div class="form-group">
                    <label for="collectionSize">Collection Size:</label>
                    <input type="number" id="collectionSize" min="1" max="10000" value="100">
                </div>
                
                <div class="form-group">
                    <label for="collectionName">Collection Name:</label>
                    <input type="text" id="collectionName" placeholder="My NFT Collection">
                </div>
                
                <canvas id="previewCanvas" width="500" height="500" aria-label="NFT Preview Canvas"></canvas>
                
                <button type="button" class="btn-primary" id="generateBtn">Generate Collection</button>
                
                <div class="progress-container">
                    <div class="progress-bar"></div>
                    <span class="progress-text">0%</span>
                </div>
            </form>
        </section>

        <!-- Output Area -->
        <section class="output-section" id="outputArea">
            <h2>Generated Collection</h2>
            <div class="collection-grid"></div>
            <button type="button" class="btn-secondary" id="downloadBtn">Download Collection</button>
        </section>
    </div>

    <!-- Cost Optimization Modules -->
    <script src="cache-manager.js" defer></script>
    <script src="budget-manager.js" defer></script>
    <script src="cost-analytics.js" defer></script>
    <script src="batch-optimizer.js" defer></script>
    <script src="smart-regeneration.js" defer></script>
    <script src="compression-manager.js" defer></script>
    
    <!-- Preview Modal -->
    <div id="qaPreviewModal" class="modal" style="display: none;" role="dialog" aria-labelledby="qaPreviewTitle">
        <div class="modal-content qa-preview-modal-content">
            <div class="modal-header">
                <h2 id="qaPreviewTitle">Preview Samples - Style Consistency Check</h2>
                <button class="modal-close" id="qaPreviewCloseBtn" aria-label="Close preview">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-summary">
                    <p>Review sample images from each category to ensure style consistency before generating the full collection.</p>
                    <div class="preview-stats">
                        <span class="stat-item">Total Samples: <strong id="previewTotalSamples">0</strong></span>
                        <span class="stat-item">Avg Score: <strong id="previewAvgScore">0</strong></span>
                        <span class="stat-item">Outliers: <strong id="previewOutlierCount">0</strong></span>
                    </div>
                </div>

                <!-- Category Tabs -->
                <div class="preview-category-tabs" id="previewCategoryTabs" role="tablist">
                    <!-- Dynamically populated: <button role="tab">Background</button> -->
                </div>

                <!-- Preview Grid -->
                <div class="preview-grid-container" id="previewGridContainer">
                    <!-- Dynamically populated with category grids -->
                </div>

                <!-- Consistency Scores -->
                <div class="consistency-scores" id="consistencyScores">
                    <!-- Dynamically populated score cards -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="qaPreviewRejectBtn" class="btn-secondary">Reject & Reconfigure</button>
                <button id="qaPreviewApproveBtn" class="btn-primary">Approve & Continue</button>
            </div>
        </div>
    </div>

    <!-- Approval Modal (Side-by-Side Comparison) -->
    <div id="qaApprovalModal" class="modal" style="display: none;" role="dialog" aria-labelledby="qaApprovalTitle">
        <div class="modal-content qa-approval-modal-content">
            <div class="modal-header">
                <h2 id="qaApprovalTitle">Image Approval - <span id="approvalCategory">Category</span></h2>
                <button class="modal-close" id="qaApprovalCloseBtn" aria-label="Close approval">&times;</button>
            </div>
            <div class="modal-body">
                <div class="approval-progress">
                    <span id="approvalProgressText">Image 1 of 10</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="approvalProgressBar" style="width: 10%"></div>
                    </div>
                </div>

                <!-- Side-by-Side Comparison -->
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <h4>Current Image</h4>
                        <img id="approvalCurrentImage" src="" alt="Current image" class="comparison-image">
                        <div class="image-metadata">
                            <span>Index: <strong id="approvalCurrentIndex">0</strong></span>
                            <span>Score: <strong id="approvalCurrentScore">0</strong></span>
                        </div>
                    </div>
                    <div class="comparison-item">
                        <h4>Reference (Highest Score)</h4>
                        <img id="approvalReferenceImage" src="" alt="Reference image" class="comparison-image">
                        <div class="image-metadata">
                            <span>Index: <strong id="approvalReferenceIndex">0</strong></span>
                            <span>Score: <strong id="approvalReferenceScore">100</strong></span>
                        </div>
                    </div>
                </div>

                <!-- Consistency Breakdown -->
                <div class="score-breakdown">
                    <h4>Consistency Breakdown</h4>
                    <div class="score-bars">
                        <div class="score-bar-item">
                            <span class="score-label">Color Consistency</span>
                            <div class="score-bar">
                                <div class="score-bar-fill" id="approvalColorScore" style="width: 0%"></div>
                            </div>
                            <span class="score-value" id="approvalColorValue">0</span>
                        </div>
                        <div class="score-bar-item">
                            <span class="score-label">Edge Density</span>
                            <div class="score-bar">
                                <div class="score-bar-fill" id="approvalEdgeScore" style="width: 0%"></div>
                            </div>
                            <span class="score-value" id="approvalEdgeValue">0</span>
                        </div>
                        <div class="score-bar-item">
                            <span class="score-label">Brightness</span>
                            <div class="score-bar">
                                <div class="score-bar-fill" id="approvalBrightnessScore" style="width: 0%"></div>
                            </div>
                            <span class="score-value" id="approvalBrightnessValue">0</span>
                        </div>
                        <div class="score-bar-item">
                            <span class="score-label">Similarity</span>
                            <div class="score-bar">
                                <div class="score-bar-fill" id="approvalSimilarityScore" style="width: 0%"></div>
                            </div>
                            <span class="score-value" id="approvalSimilarityValue">0</span>
                        </div>
                    </div>
                </div>

                <!-- Notes Input -->
                <div class="approval-notes">
                    <label for="approvalNotes">Notes (optional):</label>
                    <textarea id="approvalNotes" rows="2" placeholder="Add notes about this image..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="qaApprovalRejectBtn" class="btn-danger">Reject & Queue for Regeneration</button>
                <button id="qaApprovalSkipBtn" class="btn-secondary">Skip</button>
                <button id="qaApprovalApproveBtn" class="btn-primary">Approve</button>
            </div>
        </div>
    </div>

    <!-- Quality Assurance Module -->
    <script src="quality-assurance.js" defer></script>

    <!-- Main Application -->
    <script src="app.js" defer></script>
</body>
</html>